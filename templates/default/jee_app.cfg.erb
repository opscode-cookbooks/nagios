# Apache definitions
#
# Autogenerated by Chef.

<%
@nodes.each do |n|
host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]
  # perform a search on portals
  if n['aodn'] and n['aodn']['portal'] and n['aodn']['portal']['instances']
    n['aodn']['portal']['instances'].each do |portal_instance|
      # TODO search also in run list
      portal_hostname = n['fqdn'] # TODO not the correct hostname
      portal_url      = "http://" + portal_hostname + "/" + portal_instance['name']
      portal_version  = portal_instance['version'] ? portal_instance['version'] : ""
%>
define service {
  service_description aodn-portal <%= portal_url %>
  check_command check_portal!<%= portal_url %>!<%= portal_version %>
  host_name <%= host_name %>
  use default-service
}
<%
    end
  end
end
%>
