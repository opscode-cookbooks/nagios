# Apache definitions
#
# Autogenerated by Chef.

<%
mount_points = []
@nodes.each do |n|
  host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]
  # perform a search on mount points
  if n['aodn'] and n['aodn']['mount'] and n['aodn']['mount']['mounts']
    n['aodn']['mount']['mounts'].each do |mount_point_entry|
      mount_point            = mount_point_entry['mount_point']
      # Normalize mount point, so we can create a filename with that name
      # /mnt/imos-t4 -> _mnt_imos-t4
      mount_point_normalized = mount_point.gsub(/[\/]/, '_')
%>
define service {
  service_description disk space <%= mount_point_normalized %>
  check_command check_disk_<%= mount_point_normalized %>
  host_name <%= host_name %>
  use default-service-pnp
}
<%
      # collect all ports, so we can define commands
      mount_points.push(mount_point_normalized)
    end
  end
end
%>

<% mount_points.uniq.each do |mount_point_normalized| -%>
define command {
        command_name    check_disk_<%= mount_point_normalized %>
        command_line    $USER1$/check_nrpe -H $HOSTADDRESS$ -c check_disk_<%= mount_point_normalized %> -t 20
}
<% end -%>

