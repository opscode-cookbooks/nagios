# Autogenerated by Chef.

pid_file=<%= node['nagios']['nrpe']['pidfile'] %>
server_port=5666
nrpe_user=<%= node['nagios']['user'] %>
nrpe_group=<%= node['nagios']['group'] %>
dont_blame_nrpe=<%= node['nagios']['nrpe']['dont_blame_nrpe'] %>
debug=0
command_timeout=<%= node['nagios']['nrpe']['command_timeout'] %>
allowed_hosts=<%= @mon_host.join(',') %>
include_dir=<%= @nrpe_directory %>

command[check_zombie_procs]=<%= node['nagios']['plugin_dir'] %>/check_procs -w 5 -c 10 -s Z
command[check_total_procs]=<%= node['nagios']['plugin_dir'] %>/check_procs -w 500 -c 800
command[check_swap]=<%= node['nagios']['plugin_dir'] %>/check_swap -w '50%' -c '25%'
command[check_mem]=<%= node['nagios']['plugin_dir'] %>/check_mem.sh -w <%= node['nagios']['checks']['memory']['warning'] %> -c <%= node['nagios']['checks']['memory']['critical'] %> -p
command[check_chef_client]=<%= node['nagios']['plugin_dir'] %>/check_procs -w 1:2 -c 1:2 -C chef-client
command[check_smtp]=<%= node['nagios']['plugin_dir'] %>/check_smtp -H <%= node['nagios']['checks']['smtp_host'] %>
command[check_nginx]=<%= node['nagios']['plugin_dir'] %>/check_procs -w 2:3 -c 1:5 -C nginx
command[check_sphinx]=<%= node['nagios']['plugin_dir'] %>/check_procs -c 1:1 -C searchd
<% unless node['mysql'].nil? -%>
command[check_mysql_server]=<%= node['nagios']['plugin_dir'] %>/check_mysql -H localhost -u debian-sys-maint -p <%= node['mysql']['server_debian_password'] %>
<% end -%>

#check mailq
command[check_mailq]=<%= node['nagios']['plugin_dir'] %>/check_mailq -w 20 -c 50

#check stunnel process
command[check_stunnel]=<%= node['nagios']['plugin_dir'] %>/check_procs -c 6:6 -C stunnel4

#check nullmailer processes
command[check_nullmailer]=<%= node['nagios']['plugin_dir'] %>/check_procs -c 1:1 -C nullmailer-send

#check rsyslog processes
command[check_rsyslog]=<%= node['nagios']['plugin_dir'] %>/check_procs -c 1:1 -C rsyslogd

#check chef status
command[check_chef_status]=<%= node['nagios']['plugin_dir'] %>/check_last_logs.pl /usr/bin/chef-client 270 /var/log/syslog

#chech NTP sync
command[check_ntp]=<%= node['nagios']['plugin_dir'] %>/check_ntp_time -H <%= @ntp_server %> -w 1.5 -c 3

<% if node.roles.include?("hostname_eventstream") %>
#check eventstream process
command[check_eventstream]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "./eventstream.pl"
command[check_eventstream_logging]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['eventstream']['syslog'] %> -s /tmp/eventstream_logging -p "<%= node['nagios']['checks']['eventstream_logging']['pattern'] %>" -c 1
<% end %>

<% if node.roles.include?("urest") %>
#check nodejs process
command[check_nodejs]=<%= node['nagios']['plugin_dir'] %>/check_procs -c 1:1 -C node
<% end %>

<% if node.roles.include?("mongodb_cluster") %>
#check mongod processes
command[check_mongod]=<%= node['nagios']['plugin_dir'] %>/check_procs -c 1:1 -C mongod
<% end %>

<% if node.roles.include?("utui") %>
#check UTUI log for errors 
command[check_logfiles_utui_login_error]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['utui']['log_file'] %> -s /tmp/utui_login_error -p "<%= node['nagios']['checks']['utui_login_error']['pattern'] %>" -c 1
command[check_logfiles_utui_publish_error]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['utui']['log_file'] %> -s /tmp/utui_publish_error -p "<%= node['nagios']['checks']['utui_publish_error']['pattern'] %>" -c 1
command[check_logfiles_utui_smartFTP_error]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['utui']['log_file'] %> -s /tmp/utui_smartFTP_error -p "<%= node['nagios']['checks']['utui_smartFTP_error']['pattern'] %>" -c 1
command[check_logfiles_utui_ftp_upload_error]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['utui']['log_file'] %> -s /tmp/utui_ftp_upload_error -p "<%= node['nagios']['checks']['utui_ftp_upload_error']['pattern'] %>" -c 1
command[check_logfiles_utui_publish_insert]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['utui']['log_file'] %> -s /tmp/utui_publish_insert_error -p "<%= node['nagios']['checks']['utui_publish_insert']['pattern'] %>" -c 1
<% end %>

<% if node.recipes.include?("openvpn") %>
#check openvpn processes
command[check_openvpn]=<%= node['nagios']['plugin_dir'] %>/check_procs -c 1:1 -C openvpn
<% end %>

<% if node.recipes.include?("dnsmasq") %>
#check dnsmasq processes
command[check_dnsmasq]=<%= node['nagios']['plugin_dir'] %>/check_procs -c 1:1 -C dnsmasq
<% end %>

<% if node.recipes.include?("rabbitmq") %>
#check rabbitmq processes
command[check_rabbitmq_epmd]=<%= node['nagios']['plugin_dir'] %>/check_procs -c 1:1 -C epmd
command[check_rabbitmq_beam]=<%= node['nagios']['plugin_dir'] %>/check_procs -c 1:2 -C beam
command[check_rabbitmq_server]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "/usr/sbin/rabbitmq-server"
command[check_rabbitmq_unackd]=sudo <%= node['nagios']['plugin_dir'] %>/check_rabbitmq_unackd.py 
<% end %>

<% if node.recipes.include?("server2server") %>
#check s2s processes
command[check_s2s_tag_processor_perl]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "./s2s_tag_processor.pl"
command[check_s2s_http_perl]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "./s2s_http.pl"
command[check_s2s_tagger_perl]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "./s2s_tagger.pl"
<% end %>

<% if node.recipes.include?("sitemap_audit") %>
#check sitemap audit processes
command[check_sitemap_audit_sitemap_perl]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "./audit-sitemap.pl"
command[check_sitemap_audit_urls_perl]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "./audit-urls.pl"
command[check_sitemap_audit_complete_perl]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "./audit-complete.pl"
<% end %>

<% if node.recipes.include?("uconnect") %>
#check iron processes
command[check_iron]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "./s2s_httpd_iron.pl"
command[check_iron_processor]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "./s2s_httpd_iron_processor.pl"
#check number of files waiting to be processed in /data/store/logger/queue/process
command[check_dir_files]=<%= node['nagios']['plugin_dir'] %>/dircount.pl /data/store/logger/queue/process 100000 150000
#check logs for rabbit connection issuesi - 0000
command[check_logfiles_rabbit_connection]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['uconnect']['log_file'] %> -s /tmp/rabbit_connection -p "<%= node['nagios']['checks']['rabbit_connection']['pattern'] %>" -c 1
command[check_logfiles_rabbit_auth]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['uconnect']['log_file'] %> -s /tmp/rabbit_auth -p "<%= node['nagios']['checks']['rabbit_auth']['pattern'] %>" -c 1
<% end %>


<% if node.recipes.include?("uconnect::s2s_logger_plenv") %>
#check iron processes
command[check_iron]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "./s2s_httpd_iron.pl"
command[check_iron_processor]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "./s2s_httpd_iron_processor.pl"
#check number of files waiting to be processed in /data/store/logger/queue/process
command[check_dir_files]=<%= node['nagios']['plugin_dir'] %>/dircount.pl /data/store/logger/queue/process 100000 150000
command[check_logfiles_iron_create]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['uconnect']['syslog'] %> -s /tmp/iron_create -p "<%= node['nagios']['checks']['iron_create']['pattern'] %>" -c 1
command[check_logfiles_iron_move]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['uconnect']['syslog'] %> -s /tmp/iron_move -p "<%= node['nagios']['checks']['iron_move']['pattern'] %>" -c 1
command[check_logfiles_iron_write]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['uconnect']['syslog'] %> -s /tmp/iron_write -p "<%= node['nagios']['checks']['iron_write']['pattern'] %>" -c 1
command[check_logfiles_iron_processor_process]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['uconnect']['syslog'] %> -s /tmp/iron_processor_process -p "<%= node['nagios']['checks']['iron_processor_process']['pattern'] %>" -c 1
command[check_logfiles_iron_processor_quarantine]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['uconnect']['syslog'] %> -s /tmp/iron_processor_quarantine -p "<%= node['nagios']['checks']['iron_processor_quarantine']['pattern'] %>" -c 1


#check logs for rabbit connection issues 
<% nodesize = node[:ec2][:instance_type].split('.').last %>
<% num_procs = node[:uconnect][:iron_processes][nodesize] %>
<% for i in 1..num_procs %>
command[check_logfiles_rabbit_connection<%= i %>]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['uconnect']['log_file_'] %>-<%= i %>.log -s /tmp/rabbit_connection<%= i %> -p "<%= node['nagios']['checks']['rabbit_connection']['pattern'] %>" -c 1
command[check_logfiles_rabbit_auth<%= i %>]=sudo /usr/lib/nagios/plugins/check_log3.pl -l <%= node['nagios']['logfiles']['uconnect']['log_file_'] %>-<%= i %>.log -s /tmp/rabbit_auth<%= i %> -p "<%= node['nagios']['checks']['rabbit_auth']['pattern'] %>" -c 1
<% end %>
<% end %>

<% if node.roles.include?("dc_visitor_processor") %>
#check DC VP processes
command[check_visitor_processor]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "/var/lib/sources/data_cloud/visitor_profile_processor.one-jar.jar visitor_processor"
<% end %>

<% if node.roles.include?("dc_query_aggregator") %>
#check DC QA processes
command[check_query_aggregator]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "/var/lib/sources/data_cloud/visitor_profile_processor.one-jar.jar query_aggregator"
<% end %>

<% if node.roles.include?("dc_message_router") %>
#check DC MR processes
command[check_message_router]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "/var/lib/sources/data_cloud/visitor_profile_processor.one-jar.jar message_router"
<% end %>

<% if node.roles.include?("dc_data_distributor") %>
#check DC DD process
command[check_message_router]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "/var/lib/sources/data_cloud/visitor_profile_processor.one-jar.jar data_distributor"
<% end %>

<% if node.roles.include?("permission_cache") %>
#check permission cache process
command[check_permission_cache]=<%= node['nagios']['plugin_dir'] %>/check_procs -a "/var/lib/sources/permission_cache/permission_cache.one-jar.jar"
<% end %>

#UNUSED
#command[check_unicorn]=<%= node['nagios']['plugin_dir'] %>/check_procs -c 4:8 -C unicorn_rails
#
# memcached checks require cpan modules, "Cache::Memcached" and "Nagios::Plugins::Memcached"
#command[check_memcached_response]=/usr/local/bin/check_memcached -H <%= node["ipaddress"] %> -w 3 -c 5
#command[check_memcached_size]=/usr/local/bin/check_memcached -H <%= node["ipaddress"] %> --size-warning 60 --size-critical 80
#command[check_memcached_hit]=/usr/local/bin/check_memcached -H <%= node["ipaddress"] %> --hit-warning 40 --hit-critical 20
