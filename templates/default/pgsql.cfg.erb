# Apache definitions
#
# Autogenerated by Chef.

<%
pgsql_databases = []
@nodes.each do |n|
  host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]
  # perform a search on httpd hosts
  if n['postgresql']
    # 2013-07-19 - no databases defined, we will only use the default one (simply
    # run check_pgsql with no database), so we'll inject it!
    # TODO Remove this section once databases are defined in node definitions
    node_databases = []
    node_databases.push(n['postgresql']['databases'])
    # Push the dummy database
    node_databases.push({ "name" => "" })
    if node_databases
      node_databases.each do |pgsql_database|
        if pgsql_database
          db_name = pgsql_database['name']
%>
define service {
  service_description pgsql <%= db_name %>
  check_command check_pgsql_<%= db_name %>
  host_name <%= host_name %>
  use default-service
}
<%
          # collect all databases, so we can define commands
          pgsql_databases.push(db_name)
        end
      end
    end
  end
end
%>

<% pgsql_databases.uniq.each do |db_name| -%>
define command {
        command_name    check_pgsql_<%= db_name %>
        command_line    $USER1$/check_nrpe -H $HOSTADDRESS$ -c check_pgsql_<%= db_name %> -t 20
}
<% end -%>
