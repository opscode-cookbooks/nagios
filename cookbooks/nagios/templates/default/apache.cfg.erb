# Apache definitions
#
# Autogenerated by Chef.

<%
@nodes.each do |n|
host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]
  # perform a search on httpd hosts
  if n['apache'] and n['apache']['vhosts']
    n['apache']['vhosts'].each do |apache_vhost|
      vhost_name = apache_vhost['name']
      vhost_port = apache_vhost['port'] ? apache_vhost['port'] : 80
      vhost_uris = []
         # use the default "/" anyway
         vhost_uris.push("/")
         # iterate on all vhost redirects
         if apache_vhost['httpd_redirects']
           apache_vhost['httpd_redirects'].each do |uri_tuple|
             vhost_uris.push("/" + uri_tuple.split(":")[0])
           end
         end
         vhost_uris.uniq.each do |vhost_uri|
%>
define service {
  service_description apache vhost <%= vhost_name %>:<%= vhost_port %><%= vhost_uri %>
  check_command check_http!<%= vhost_name %>!<%= vhost_port %>!<%= vhost_uri %>
  host_name <%= host_name %>
  use default-service-pnp
}
<%
      end
    end
  end
end
%>

<%
# Handle websites on unmanaged hosts
@unmanaged_hosts.each do |n|
  host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]
  if n['websites']
    n['websites'].each do |website|
      vhost_name = website['name']
      vhost_port = website['port'] ? website['port'] : 80
      vhost_uri  = website['uri'] ? website['uri'] : "/"
%>
define service {
  service_description apache vhost <%= vhost_name %>:<%= vhost_port %><%= vhost_uri %>
  check_command check_http!<%= vhost_name %>!<%= vhost_port %>!<%= vhost_uri %>
  host_name <%= host_name %>
  use default-service-pnp
}
<%
    end
  end
end
%>
