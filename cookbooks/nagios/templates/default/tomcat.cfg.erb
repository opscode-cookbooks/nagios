# Apache definitions
#
# Autogenerated by Chef.

<%
tomcat_ports = []
@nodes.each do |n|
  host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]
  # perform a search on httpd hosts
  if n['tomcat'] and n['tomcat']['instances']
    n['tomcat']['instances'].each do |tomcat_instance|
      instance_name = tomcat_instance['name']
      instance_port = tomcat_instance['ports']['connector_port'] ? tomcat_instance['ports']['connector_port'] : 8080
%>
define service {
  service_description tomcat instance <%= instance_name %>:<%= instance_port %>
  check_command check_tomcat_<%= instance_port %>
  host_name <%= host_name %>
  use default-service-pnp
}
<%
      # collect all ports, so we can define commands
      tomcat_ports.push(instance_port)
    end
  end
end
%>

<% tomcat_ports.uniq.each do |tomcat_port| -%>
define command {
        command_name    check_tomcat_<%= tomcat_port %>
        command_line    $USER1$/check_nrpe -H $HOSTADDRESS$ -c check_tomcat_<%= tomcat_port %> -t 20
}
<% end -%>
